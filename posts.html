
<!DOCTYPE html>
<html lang="sr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <title>Posts</title>
  <!-- Include your CSS styles here (omitted for brevity) -->
</head>
<body>

<script>
if (!localStorage.getItem("userRole")) {
  window.location.href = "index.html";
}
</script>

<div class="watermark">T&amp;M<br>Solutions<br>HR</div>
<div class="menu-icon" onclick="toggleMenu()">
  <span></span><span></span><span></span>
</div>
<nav class="menu" id="sideMenu">
  <div class="menu-logo">
    <img src="logo.png" alt="T&amp;M HR Logo"/>
  </div>
  <a id="helpMenuBtn" href="#">–ü–æ–º–æ—õ</a>
  <a class="logout" href="index.html">–û–¥—ò–∞–≤–∏ —Å–µ</a>
</nav>

<div class="modal" id="helpModal">
  <div class="modal-content">
    <div class="close" onclick="closeHelp()">‚úï</div>
    <h2>–ü–æ–º–æ—õ</h2>
    <p>–ï-–ø–æ—à—Ç–∞: <a href="mailto:info@timhr.rs">info@timhr.rs</a></p>
    <p>–¢–µ–ª–µ—Ñ–æ–Ω: <a href="tel:+381621246823">+381 62 124 6823</a></p>
    <p>–¢–µ–ª–µ—Ñ–æ–Ω: <a href="tel:+381621246824">+381 62 124 6824</a></p>
  </div>
</div>

<div class="feed" id="postsContainer"></div>
<div class="floating-btn" onclick="openModal()">+</div>

<div class="modal" id="postModal">
  <div class="modal-content">
    <textarea id="modalText" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –Ω–µ—à—Ç–æ‚Ä¶"></textarea>
    <div class="custom-file">
      <label for="modalPhoto">üìé –ò–∑–∞–±–µ—Ä–∏ —Ñ–∞—ò–ª</label>
      <span id="fileName">–ù–∏—ò–µ–¥–∞–Ω —Ñ–∞—ò–ª –Ω–∏—ò–µ –∏–∑–∞–±—Ä–∞–Ω</span>
      <input type="file" id="modalPhoto" accept="image/*" onchange="updateFileName()"/>
    </div>
    <div class="actions">
      <button class="cancel-btn" onclick="closeModal()">–û—Ç–∫–∞–∂–∏</button>
      <button class="submit-btn" onclick="submitPost()">–û–∫–∞—á–∏</button>
    </div>
  </div>
</div>

<script>
const API = "/api/posts";
const userRole = localStorage.getItem("userRole");

window.addEventListener('DOMContentLoaded', () => {
  if (userRole !== "admin") {
    document.querySelector('.floating-btn').style.display = 'none';
  }
  loadPosts();
});

function formatTs(ts) {
  const d = new Date(ts);
  const dd = String(d.getDate()).padStart(2, '0');
  const mm = String(d.getMonth() + 1).padStart(2, '0');
  const yy = d.getFullYear();
  const hh = String(d.getHours()).padStart(2, '0');
  const min = String(d.getMinutes()).padStart(2, '0');
  return `${dd}/${mm}/${yy} ${hh}:${min}`;
}

let posts = [];

async function loadPosts() {
  const res = await fetch(API);
  posts = await res.json();
  renderPosts();
}

function createPostElement(p) {
  const div = document.createElement('div');
  div.className = 'post';
  div.innerHTML = `
    <div class="datetime">${formatTs(p.timestamp)}</div>
    <div class="author">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä <span class="pin-icon" style="display:${p.pinned ? 'inline' : 'none'};">üìå</span></div>
    ${userRole === "admin" ? `
      <div class="post-menu" onclick="togglePostMenu(this)">‚ãØ</div>
      <div class="menu-options">
        <button onclick="togglePin('${p.id}')">${p.pinned ? '–î–µ–ø–∏–Ω—É—ò' : '–ü–∏–Ω—É—ò'}</button>
        <button onclick="startEdit('${p.id}')">–£—Ä–µ–¥–∏</button>
        <button onclick="removePost('${p.id}')">–û–±—Ä–∏—à–∏</button>
      </div>` : ''}
    <div class="post-content">${p.text}</div>
    ${p.img ? `<img src="${p.img}" alt=""/>` : ''}
  `;
  return div;
}

async function submitPost() {
  const text = document.getElementById('modalText').value.trim();
  const photo = document.getElementById('modalPhoto').files[0];
  let imgData = null;
  if (photo) {
    imgData = await new Promise(r => {
      const fr = new FileReader();
      fr.onload = () => r(fr.result);
      fr.readAsDataURL(photo);
    });
  }
  await fetch(API, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ text, img: imgData })
  });
  closeModal();
  loadPosts();
}

async function togglePin(id) {
  const post = posts.find(p => p.id === id);
  await fetch(`${API}/${id}`, {
    method: "PUT",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ pinned: !post.pinned })
  });
  loadPosts();
}

async function removePost(id) {
  await fetch(`${API}/${id}`, { method: "DELETE" });
  loadPosts();
}

function startEdit(id) {
  const postEl = [...document.querySelectorAll('.post')].find(el =>
    el.innerHTML.includes(`togglePin('${id}')`)
  );
  const p = posts.find(x => x.id === id);
  const content = postEl.querySelector('.post-content');
  content.innerHTML = `<textarea>${p.text}</textarea>
    <div class="edit-actions">
      <button onclick="saveEdit('${id}')">–°–∞—á—É–≤–∞—ò</button>
      <button onclick="loadPosts()">–û—Ç–∫–∞–∂–∏</button>
    </div>`;
}

async function saveEdit(id) {
  const postEl = [...document.querySelectorAll('.post')].find(el =>
    el.innerHTML.includes(`togglePin('${id}')`)
  );
  const newText = postEl.querySelector('textarea').value;
  await fetch(`${API}/${id}`, {
    method: "PUT",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ text: newText })
  });
  loadPosts();
}

function toggleMenu() {
  document.getElementById('sideMenu').classList.toggle('open');
}

function openModal() {
  document.getElementById('postModal').classList.add('open');
}

function closeModal() {
  document.getElementById('postModal').classList.remove('open');
  document.getElementById('modalText').value = '';
  document.getElementById('modalPhoto').value = '';
  document.getElementById('fileName').textContent = '–ù–∏—ò–µ–¥–∞–Ω —Ñ–∞—ò–ª –Ω–∏—ò–µ –∏–∑–∞–±—Ä–∞–Ω';
}

document.getElementById('helpMenuBtn').onclick = e => {
  e.preventDefault();
  document.getElementById('helpModal').classList.add('open');
};

function closeHelp() {
  document.getElementById('helpModal').classList.remove('open');
}

function updateFileName() {
  const inp = document.getElementById('modalPhoto'),
        lbl = document.getElementById('fileName');
  lbl.textContent = inp.files[0]?.name || '–ù–∏—ò–µ–¥–∞–Ω —Ñ–∞—ò–ª –Ω–∏—ò–µ –∏–∑–∞–±—Ä–∞–Ω';
}

document.addEventListener('click', e => {
  document.querySelectorAll('.menu-options').forEach(m => {
    if (!m.contains(e.target) && !m.previousElementSibling.contains(e.target)) {
      m.style.display = 'none';
    }
  });
});

function togglePostMenu(el) {
  const menu = el.nextElementSibling;
  menu.style.display = menu.style.display === 'flex' ? 'none' : 'flex';
}
</script>

</body>
</html>
