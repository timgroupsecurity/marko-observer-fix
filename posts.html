<!DOCTYPE html>
<html lang="sr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <title>Posts</title>
  <style>/* your existing CSS… */</style>
</head>
<body>

<script>
  // Redirect to login if no role set
  if (!localStorage.getItem("userRole")) {
    window.location.href = "index.html";
  }
</script>

<div class="watermark">T&amp;M<br>Solutions<br>HR</div>
<div class="menu-icon" onclick="toggleMenu()"><span></span><span></span><span></span></div>
<nav class="menu" id="sideMenu">…</nav>
<div class="modal" id="helpModal">…</div>

<div class="feed" id="postsContainer"></div>
<div class="floating-btn" onclick="openModal()">+</div>
<div class="modal" id="postModal">…</div>

<script>
  // ─── UTILS ──────────────────────────────────────────────────────────────
  const API = "/api/posts";
  function formatTs(ts) {
    const d=new Date(ts),
          dd=String(d.getDate()).padStart(2,'0'),
          mm=String(d.getMonth()+1).padStart(2,'0'),
          yy=d.getFullYear(),
          hh=String(d.getHours()).padStart(2,'0'),
          min=String(d.getMinutes()).padStart(2,'0');
    return `${dd}/${mm}/${yy} ${hh}:${min}`;
  }

  // ─── FETCH + RENDER ─────────────────────────────────────────────────────
  let posts = [];
  async function loadPosts() {
    const res = await fetch(API);
    posts = await res.json();
    renderPosts();
  }

  function createPostElement(p) {
    const div = document.createElement('div');
    div.className = 'post';
    div.innerHTML = `
      <div class="datetime">${formatTs(p.timestamp)}</div>
      <div class="author">Администратор <span class="pin-icon">📌</span></div>
      <div class="post-menu" onclick="togglePostMenu(this)">⋯</div>
      <div class="menu-options">
        <button onclick="togglePin('${p.id}')">${p.pinned? 'Депинуј':'Пинуј'}</button>
        <button onclick="startEdit('${p.id}')">Уреди</button>
        <button onclick="removePost('${p.id}')">Обриши</button>
      </div>
      <div class="post-content">${p.text}</div>
      ${p.img? `<img src="${p.img}" alt="">` : ''}
    `;
    if (p.pinned) div.querySelector('.pin-icon').style.display = 'inline';
    return div;
  }

  function renderPosts() {
    const container = document.getElementById('postsContainer');
    container.innerHTML = '';
    // pinned first
    posts
      .sort((a,b)=> (b.pinned?1:0)-(a.pinned?1:0))
      .forEach(p => container.appendChild(createPostElement(p)));
  }

  // ─── CRUD ACTIONS ──────────────────────────────────────────────────────
  async function submitPost() {
    const text = document.getElementById('modalText').value.trim();
    const photo = document.getElementById('modalPhoto').files[0];
    let imgData = null;
    if (photo) {
      imgData = await new Promise(r => {
        const fr = new FileReader();
        fr.onload = () => r(fr.result);
        fr.readAsDataURL(photo);
      });
    }
    await fetch(API, {
      method: "POST",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify({ text, img: imgData })
    });
    closeModal();
    loadPosts();
  }

  async function togglePin(id){
    const post = posts.find(p=>p.id===id);
    await fetch(`${API}/${id}`, {
      method: "PUT",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ pinned: !post.pinned })
    });
    loadPosts();
  }

  async function removePost(id){
    await fetch(`${API}/${id}`, { method: "DELETE" });
    loadPosts();
  }

  function startEdit(id){
    const postEl = [...document.querySelectorAll('.post')]
      .find(el=> el.querySelector(".menu-options button").onclick
        .toString().includes(id)
      );
    const p = posts.find(x=>x.id===id);
    const content = postEl.querySelector('.post-content');
    content.innerHTML = `<textarea>${p.text}</textarea>
      <div class="edit-actions">
        <button onclick="saveEdit('${id}')">Сачувај</button>
        <button onclick="loadPosts()">Откажи</button>
      </div>`;
  }
  async function saveEdit(id){
    const postEl = [...document.querySelectorAll('.post')]
      .find(el=> el.querySelector(".menu-options button").onclick
        .toString().includes(id)
      );
    const newText = postEl.querySelector('textarea').value;
    await fetch(`${API}/${id}`, {
      method: "PUT",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ text: newText })
    });
    loadPosts();
  }

  // ─── MISC UI ────────────────────────────────────────────────────────────
  function toggleMenu(){ document.getElementById('sideMenu').classList.toggle('open'); }
  function openModal(){ document.getElementById('postModal').classList.add('open'); }
  function closeModal(){
    document.getElementById('postModal').classList.remove('open');
    document.getElementById('modalText').value = '';
    document.getElementById('modalPhoto').value = '';
    document.getElementById('fileName').textContent = 'Ниједан фајл није изабран';
  }
  document.getElementById('helpMenuBtn').onclick = e=>{ e.preventDefault(); document.getElementById('helpModal').classList.add('open'); };
  function closeHelp(){ document.getElementById('helpModal').classList.remove('open'); }
  function updateFileName(){
    const inp = document.getElementById('modalPhoto'),
          lbl = document.getElementById('fileName');
    lbl.textContent = inp.files[0]?.name || 'Ниједан фајл није изабран';
  }
  document.addEventListener('click', e=> {
    document.querySelectorAll('.menu-options').forEach(m=> {
      if (!m.contains(e.target) && !m.previousElementSibling.contains(e.target)) {
        m.style.display = 'none';
      }
    });
  });
  window.addEventListener('DOMContentLoaded', loadPosts);
</script>

</body>
</html>
